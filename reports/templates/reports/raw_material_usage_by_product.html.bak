{% extends "base_reports.html" %}

{% block title %}تقرير توزيع المادة الخام على المنتجات{% endblock %}

{% block filters %}
<form method="get" class="row g-2 mb-3">
  <div class="col-md-4">
    <label class="form-label">الفترة</label>
    <select name="period" class="form-select">
      {% for p in periods %}
        <option value="{{ p.id }}"
          {% if current_period and p.id == current_period.id %}selected{% endif %}>
          {{ p.name }} ({{ p.start_date }} - {{ p.end_date }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4">
    <label class="form-label">المادة الخام</label>
    <select name="raw_material" class="form-select">
      <option value="">-- اختر المادة الخام --</option>
      {% for m in materials %}
        <option value="{{ m.id }}"
          {% if selected_material and m.id == selected_material.id %}selected{% endif %}>
          {{ m.name }} {% if m.sku %} ({{ m.sku }}){% endif %}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2 align-self-end">
    <button type="submit" class="btn btn-primary w-100">عرض</button>
  </div>
</form>
{% endblock %}

{% block content %}

{% if selected_material %}
  <div class="mb-3">
    <strong>المادة الخام المختارة:</strong>
    {{ selected_material.name }}
    {% if selected_material.sku %} - {{ selected_material.sku }}{% endif %}
  </div>

  <table class="table table-striped table-bordered table-sm">
    <thead class="table-secondary">
      <tr>
        <th>#</th>
        <th>كود المنتج</th>
        <th>المنتج النهائي</th>
        <th>كمية المادة في كل طلب (حسب الـ BOM)</th>
        <th>وحدة المادة</th>
        <th>إجمالي عدد الطلبات</th>
        <th>إجمالي الكمية المستهلكة</th>
        <th>إجمالي التكلفة</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ row.product_code }}</td>
          <td>{{ row.product_name }}</td>
          <td>
            {% if row.per_order_qty %}
              {{ row.per_order_qty|floatformat:3 }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if row.per_order_unit %}
              {{ row.per_order_unit }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ row.total_qty_sold|floatformat:0 }}</td>
          <td>{{ row.total_qty_consumed|floatformat:3 }}</td>
          <td>{{ row.total_cost|floatformat:3 }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center">
            لا توجد بيانات لهذه المادة الخام في الفترة المحددة.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="alert alert-info">
    من فضلك اختر مادة خام من أعلى لعرض التقرير.
  </div>
{% endif %}

{% endblock %}
