{% load numfmt %}
{# templates/reports/product_cost_breakdown.html #}
{% extends "base_reports.html" %}

{% block title %}ุชูุฑูุฑ ุชูููุฉ ุงูููุชุฌ (ุชูููู ุงูููููุงุช){% endblock %}

{% block filters %}
<form method="get" class="row g-2 mb-3">

  <div class="col-md-3">
    <label class="form-label">ุงููุชุฑุฉ</label>
    <select name="period" class="form-select">
      {% for p in periods %}
        <option value="{{ p.id }}"
          {% if current_period and p.id == current_period.id %}selected{% endif %}>
          {{ p.name }} ({{ p.start_date }} - {{ p.end_date }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-5">
    <label class="form-label">ุงูููุชุฌ</label>
    <select name="product" class="form-select">
      <option value="">-- ุงุฎุชุฑ ููุชุฌุงู --</option>
      {% for pr in products %}
        <option value="{{ pr.id }}"
          {% if selected_product and pr.id == selected_product.id %}selected{% endif %}>
          {{ pr.code }} - {{ pr.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">ุงููููุฉ</label>
    <input type="number" step="0.001" name="qty"
           value="{{ qty }}" class="form-control">
  </div>

  <div class="col-md-2 align-self-end">
    <button type="submit" class="btn btn-primary w-100">
      ุนุฑุถ ุงูุชูุฑูุฑ
    </button>
  </div>

</form>
{% endblock %}

{% block content %}

{% if selected_product and current_period and report %}

  {# ุฃุฒุฑุงุฑ PDF #}
  <div class="mb-3 text-end">
    <a href="{% url 'product_cost_breakdown_pdf' %}?period={{ current_period.id }}&product={{ selected_product.id }}&qty={{ qty }}" class="btn btn-danger btn-sm">
      ุชุญููู PDF ููุฐุง ุงูููุชุฌ
    </a>
    <a href="{% url 'product_cost_breakdown_all_pdf' %}?period={{ current_period.id }}&qty={{ qty }}" class="btn btn-outline-danger btn-sm">
      ุชุญููู PDF ููู ุงูููุชุฌุงุช
    </a>
  </div>

  {# ุงุณู ุงูููุชุฌ ูุจูุฑ ูู ุงูููุชุตู #}
  <div class="text-center my-3">
    <h1 style="
        font-size: 36px;
        font-weight: 800;
        color: #0d6efd;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    ">
        {{ selected_product.code }} - {{ selected_product.name }}
    </h1>
  </div>

  <div class="card mb-4 shadow-sm">

    <div class="card-header bg-light">
      <div class="d-flex justify-content-between flex-wrap">
        <div class="mb-1">
          <strong>ุงููุชุฑุฉ:</strong>
          {{ current_period.name }} ({{ current_period.start_date }} - {{ current_period.end_date }})
        </div>
        <div class="mb-1">
          <strong>ุงููููุฉ ุงููุทููุจ ุญุณุงุจ ุชูููุชูุง:</strong>
          {{ qty|num:3 }}
        </div>
      </div>
    </div>

    <div class="card-body p-2">

      {# ================= ุฌุฏูู ุงููุณุชูู ุงูุฃูู ================= #}
      <h5 class="mt-1 mb-2">
        ๐งฑ ูููููุงุช ุงููุณุชูู ุงูุฃูู
      </h5>

      <table class="table table-bordered table-striped table-sm align-middle mb-3">
        <thead class="table-secondary text-center">
          <tr>
            <th style="width: 110px;">ุงูููุน</th>
            <th style="width: 100px;">ุงูููุฏ</th>
            <th>ุงูุงุณู</th>
            <th style="width: 220px;">ุงููุตุฏุฑ / ุงูููุชุฌ ุงูุฃุนูู</th>
            <th style="width: 70px;">ุงููุณุชูู</th>
            <th style="width: 140px;">ูููุฉ ูู ุงููุตูุฉ</th>
            <th style="width: 140px;">ุงููููุฉ ุงูุฅุฌูุงููุฉ</th>
            <th style="width: 140px;">ุชูููุฉ ุงููุญุฏุฉ</th>
            <th style="width: 160px;">ุฅุฌูุงูู ุงูุชูููุฉ</th>
          </tr>
        </thead>
        <tbody>

          {% for row in report.level1_lines %}
            <tr
              class="
                {% if row.type == 'raw' %}
                  table-success
                {% elif row.type == 'manufactured' %}
                  table-warning
                {% endif %}
              "
            >
              <td class="text-center">
                {% if row.type == "raw" %}
                  <span class="badge bg-success">ูุงุฏุฉ ุฎุงู</span>
                {% elif row.type == "manufactured" %}
                  <span class="badge bg-warning text-dark">ููุชุฌ ูุตู ูุตูุน</span>
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.code }}
              </td>

              <td>
                {{ row.name }}
              </td>

              <td class="text-center">
                {{ row.parent }}
              </td>

              <td class="text-center">
                {{ row.level }}
              </td>

              <td class="text-end">
                {% if row.per_order_qty %}
                  {{ row.per_order_qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.qty %}
                  {{ row.qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.unit_cost %}
                  {{ row.unit_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.type == "raw" and row.total_cost %}
                  {{ row.total_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" class="text-center">
                ูุง ุชูุฌุฏ ููููุงุช ูู ุงููุณุชูู ุงูุฃูู.
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="8" class="text-end">
              ุฅุฌูุงูู ุชูููุฉ ูููููุงุช ุงููุณุชูู ุงูุฃูู (ููุงุฏ ุฎุงู ููุท):
            </td>
            <td class="text-end">
              {{ report.level1_total_cost|num:3 }}
            </td>
          </tr>
        </tfoot>
      </table>

      {# ================= ุฌุฏูู ุงููุณุชูู ุงูุซุงูู ููุง ุจุนุฏู ================= #}
      <h5 class="mt-3 mb-2">
        ๐งฌ ูููููุงุช ุงููุณุชููุงุช ุงูุซุงููุฉ (2 ูุฃุนูู)
      </h5>

      <table class="table table-bordered table-striped table-sm align-middle mb-3">
        <thead class="table-secondary text-center">
          <tr>
            <th style="width: 110px;">ุงูููุน</th>
            <th style="width: 100px;">ุงูููุฏ</th>
            <th>ุงูุงุณู</th>
            <th style="width: 220px;">ุงููุตุฏุฑ / ุงูููุชุฌ ุงูุฃุนูู</th>
            <th style="width: 70px;">ุงููุณุชูู</th>
            <th style="width: 140px;">ูููุฉ ูู ุงููุตูุฉ</th>
            <th style="width: 140px;">ุงููููุฉ ุงูุฅุฌูุงููุฉ</th>
            <th style="width: 140px;">ุชูููุฉ ุงููุญุฏุฉ</th>
            <th style="width: 160px;">ุฅุฌูุงูู ุงูุชูููุฉ</th>
          </tr>
        </thead>
        <tbody>

          {% for row in report.level2_lines %}
            <tr
              class="
                {% if row.type == 'raw' %}
                  table-success
                {% elif row.type == 'manufactured' %}
                  table-warning
                {% endif %}
              "
            >
              <td class="text-center">
                {% if row.type == "raw" %}
                  <span class="badge bg-success">ูุงุฏุฉ ุฎุงู</span>
                {% elif row.type == "manufactured" %}
                  <span class="badge bg-warning text-dark">ููุชุฌ ูุตู ูุตูุน</span>
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.code }}
              </td>

              <td>
                {% if row.level > 1 %}
                  <span style="padding-right: {{ row.level|add:'-1' }}0px;">
                    โฎ {{ row.name }}
                  </span>
                {% else %}
                  {{ row.name }}
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.parent }}
              </td>

              <td class="text-center">
                {{ row.level }}
              </td>

              <td class="text-end">
                {% if row.per_order_qty %}
                  {{ row.per_order_qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.qty %}
                  {{ row.qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.unit_cost %}
                  {{ row.unit_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.type == "raw" and row.total_cost %}
                  {{ row.total_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" class="text-center">
                ูุง ุชูุฌุฏ ููููุงุช ูู ุงููุณุชููุงุช ุงูุฃุนูู.
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="8" class="text-end">
              ุฅุฌูุงูู ุชูููุฉ ูููููุงุช ุงููุณุชููุงุช ุงูุซุงููุฉ (ููุงุฏ ุฎุงู ููุท):
            </td>
            <td class="text-end">
              {{ report.level2_total_cost|num:3 }}
            </td>
          </tr>
        </tfoot>
      </table>

      {# ================= ุฅุฌูุงูู ุชูููุฉ ุงููุตูุฉ ================= #}
      <div class="text-center my-4">
        <h1 style="
            font-size: 32px;
            font-weight: 800;
            color: #198754;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        ">
            ุฅุฌูุงูู ุชูููุฉ ุงููุตูุฉ ูููููุฉ
            {{ qty|num:0 }}
            ูู ุงูููุชุฌ:
            <span style="color:#0d6efd;">
                {{ report.product_total_cost|num:0 }}
                ุฑูุงู
            </span>
        </h1>
      </div>

    </div>
  </div>

{% else %}
  <div class="alert alert-info text-center">
    ูู ูุถูู ุงุฎุชุฑ ุงููุชุฑุฉ ูุงูููุชุฌ ุซู ุงุถุบุท "ุนุฑุถ ุงูุชูุฑูุฑ".
  </div>
{% endif %}

{% endblock %}
