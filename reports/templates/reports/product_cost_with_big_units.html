{% extends "base_reports.html" %}{% load numfmt %}
{# templates/reports/product_cost_with_big_units.html #}


{% block title %}ุชูุฑูุฑ ุชูููุฉ ุงูููุชุฌ (ูุญุฏุงุช ุงูุดุฑุงุก ุงููุจูุฑุฉ){% endblock %}

{# =============================== ุงูููุงุชุฑ =============================== #}
{% block filters %}
<form method="get" class="row g-2 mb-3">
  <div class="col-md-3">
    <label class="form-label">ุงููุชุฑุฉ</label>
    <select name="period" class="form-select">
      {% for p in periods %}
        <option value="{{ p.id }}"
          {% if current_period and p.id == current_period.id %}selected{% endif %}>
          {{ p.name }} ({{ p.start_date }} - {{ p.end_date }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-5">
    <label class="form-label">ุงูููุชุฌ</label>
    <select name="product" class="form-select">
      <option value="">-- ุงุฎุชุฑ ููุชุฌุงู --</option>
      {% for pr in products %}
        <option value="{{ pr.id }}"
          {% if selected_product and pr.id == selected_product.id %}selected{% endif %}>
          {{ pr.code }} - {{ pr.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">ุงููููุฉ</label>
    <input type="number" step="0.001" name="qty"
           value="{{ qty }}" class="form-control">
  </div>

  <div class="col-md-2 align-self-end">
    <button type="submit" class="btn btn-primary w-100">
      ุนุฑุถ ุงูุชูุฑูุฑ
    </button>
  </div>

</form>
{% endblock %}

{# =============================== ุงููุญุชูู =============================== #}
{% block content %}

{% if selected_product and current_period and level1_rows %}

  {# ุนููุงู ุงูููุชุฌ ูุงููุชุฑุฉ #}
  <div class="text-center my-3">
    <h1 style="
        font-size: 32px;
        font-weight: 800;
        color: #0d6efd;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    ">
      {{ selected_product.code }} - {{ selected_product.name }}
    </h1>
    <div class="mt-1">
      <strong>ุงููุชุฑุฉ:</strong>
      {{ current_period.name }} ({{ current_period.start_date }} - {{ current_period.end_date }})
      &nbsp; | &nbsp;
      <strong>ุงููููุฉ ุงููุทููุจ ุญุณุงุจ ุชูููุชูุง:</strong>
      {{ qty|num:3 }}
    </div>
  </div>

  {# ุฃุฒุฑุงุฑ ุชุตุฏูุฑ PDF #}
  <div class="mb-3 text-end">
    <a href="{% url 'product_cost_with_big_units_pdf' %}?period={{ current_period.id }}&product={{ selected_product.id }}&qty={{ qty }}"
       class="btn btn-danger btn-sm">
      ๐ ุชุญููู PDF (ูุญุฏุงุช ูุจูุฑุฉ) ููุฐุง ุงูููุชุฌ
    </a>

    <a href="{% url 'product_cost_with_big_units_all_pdf' %}?period={{ current_period.id }}&qty={{ qty }}"
       class="btn btn-outline-danger btn-sm">
      ๐ ุชุญููู PDF (ูุญุฏุงุช ูุจูุฑุฉ) ูุฌููุน ุงูููุชุฌุงุช
    </a>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-body p-2">

      {# =================== ุงูุฌุฏูู ุงูุฃูู =================== #}
      <h5 class="mt-1 mb-2">
        ๐งฑ ูููููุงุช ุงููุณุชูู ุงูุฃูู (ููุงุฏ ุฎุงู + ููุชุฌุงุช ูุตู ูุตูุน)
      </h5>

      <table class="table table-bordered table-striped table-sm align-middle mb-3">
        <thead class="table-secondary text-center">
          <tr>
            <th style="width: 100px;">ุงูููุน</th>
            <th style="width: 110px;">ุงูููุฏ</th>
            <th>ุงุณู ุงููุงุฏุฉ</th>
            <th style="width: 130px;">ูุญุฏุฉ ุงูููุงุณ ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุญุฌู ูุญุฏุฉ ุงูุดุฑุงุก ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุณุนุฑ ูุญุฏุฉ ุงูุดุฑุงุก ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุงููููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงููุตูุฉ</th>
            <th style="width: 130px;">ุงููุญุฏุฉ ุงูุตุบูุฑุฉ</th>
            <th style="width: 150px;">ุงูุชูููุฉ</th>
          </tr>
        </thead>
        <tbody>

          {% for row in level1_rows %}
            <tr
              class="
                {% if row.type == 'raw' %}
                  table-success
                {% elif row.type == 'manufactured' %}
                  table-warning
                {% endif %}
              "
            >
              <td class="text-center">
                {% if row.type == "raw" %}
                  <span class="badge bg-success">ูุงุฏุฉ ุฎุงู</span>
                {% elif row.type == "manufactured" %}
                  <span class="badge bg-warning text-dark">ููุชุฌ ูุตู ูุตูุน</span>
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.code }}
              </td>

              <td>
                {{ row.name }}
              </td>

              <td class="text-center">
                {{ row.big_unit_name }}
              </td>

              <td class="text-center">
                {% if row.big_unit_qty %}
                  {{ row.big_unit_qty|num:0 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.big_unit_price %}
                  {{ row.big_unit_price|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.qty %}
                  {{ row.qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.small_unit_name }}
              </td>

              <td class="text-end">
                {% if row.total_cost %}
                  {{ row.total_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" class="text-center">
                ูุง ุชูุฌุฏ ููููุงุช ูู ุงููุณุชูู ุงูุฃูู.
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="8" class="text-end">
              ุฅุฌูุงูู ุชูููุฉ ูููููุงุช ุงููุณุชูู ุงูุฃูู:
            </td>
            <td class="text-end">
              {{ level1_total_cost|num:3 }}
            </td>
          </tr>
        </tfoot>
      </table>

      {# =================== ุงูุฌุฏูู ุงูุซุงูู =================== #}
      <h5 class="mt-3 mb-2">
        ๐งฌ ูููููุงุช ุงูููุชุฌุงุช ุงููุตููุนุฉ (ุงููุณุชููุงุช ุงูุซุงููุฉ ูุฃุนูู)
      </h5>

      <table class="table table-bordered table-striped table-sm align-middle mb-3">
        <thead class="table-secondary text-center">
          <tr>
            <th style="width: 100px;">ุงูููุน</th>
            <th style="width: 110px;">ุงูููุฏ</th>
            <th>ุงุณู ุงููุงุฏุฉ</th>
            <th style="width: 130px;">ูุญุฏุฉ ุงูููุงุณ ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุญุฌู ูุญุฏุฉ ุงูุดุฑุงุก ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุณุนุฑ ูุญุฏุฉ ุงูุดุฑุงุก ุงููุจูุฑุฉ</th>
            <th style="width: 160px;">ุงููููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงููุตูุฉ</th>
            <th style="width: 130px;">ุงููุญุฏุฉ ุงูุตุบูุฑุฉ</th>
            <th style="width: 150px;">ุงูุชูููุฉ</th>
          </tr>
        </thead>
        <tbody>

          {% for row in level2_rows %}
            <tr
              class="
                {% if row.type == 'raw' %}
                  table-success
                {% elif row.type == 'manufactured' %}
                  table-warning
                {% endif %}
              "
            >
              <td class="text-center">
                {% if row.type == "raw" %}
                  <span class="badge bg-success">ูุงุฏุฉ ุฎุงู</span>
                {% elif row.type == "manufactured" %}
                  <span class="badge bg-warning text-dark">ููุชุฌ ูุตู ูุตูุน</span>
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.code }}
              </td>

              <td>
                {{ row.name }}
              </td>

              <td class="text-center">
                {{ row.big_unit_name }}
              </td>

              <td class="text-center">
                {% if row.big_unit_qty %}
                  {{ row.big_unit_qty|num:0 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.big_unit_price %}
                  {{ row.big_unit_price|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                {% if row.qty %}
                  {{ row.qty|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-center">
                {{ row.small_unit_name }}
              </td>

              <td class="text-end">
                {% if row.total_cost %}
                  {{ row.total_cost|num:3 }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" class="text-center">
                ูุง ุชูุฌุฏ ูููููุงุช ูู ุงููุณุชููุงุช ุงูุฃุนูู.
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="table-info fw-bold">
            <td colspan="8" class="text-end">
              ุฅุฌูุงูู ุชูููุฉ ูููููุงุช ุงูููุชุฌุงุช ุงููุตููุนุฉ (ุงููุณุชููุงุช ุงูุซุงููุฉ ูุฃุนูู):
            </td>
            <td class="text-end">
              {{ level2_total_cost|num:3 }}
            </td>
          </tr>
        </tfoot>
      </table>

      {# =================== ุฅุฌูุงูู ุชูููุฉ ุงููุตูุฉ =================== #}
      {% if product_total_cost %}
        <div class="text-center my-4">
          <h2 style="
              font-size: 26px;
              font-weight: 800;
              color: #198754;
              text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
          ">
            ุฅุฌูุงูู ุชูููุฉ ุงููุตูุฉ ูููููุฉ
            {{ qty|num:0 }}
            ูู ุงูููุชุฌ:
            <span style="color:#0d6efd;">
              {{ product_total_cost|num:2 }}
              ุฑูุงู
            </span>
          </h2>
        </div>
      {% endif %}

    </div>
  </div>

{% else %}
  <div class="alert alert-info text-center">
    ูู ูุถูู ุงุฎุชุฑ ุงููุชุฑุฉ ูุงูููุชุฌ ุซู ุงุถุบุท "ุนุฑุถ ุงูุชูุฑูุฑ".
  </div>
{% endif %}

{% endblock %}
