{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุชุณุนูุฑ ููุชุฌ ูุงุญุฏ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f5f7fb; }
    .card { border-radius: 14px; }
    .badge-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .muted { color:#6c757d; font-size:.9rem; }
    .kpi { font-size: 1.1rem; font-weight: 700; }
    .kpi small { font-weight: 500; color:#6c757d; display:block; margin-bottom:4px; }
  </style>
</head>
<body>

<div class="container-fluid p-3">
  <div class="row g-3">

    <!-- โ ุงุฎุชูุงุฑ ุงูููุชุฌ ูุงููุชุฑุฉ -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">ุงูููุชุฌ</label>
              <select id="product" class="form-select">
                <option value="">โ ุงุฎุชุฑ ููุชุฌ โ</option>
                {% for p in products %}
                  <option value="{{ p.id }}">{{ p.code }} โ {{ p.name }}</option>
                {% endfor %}
              </select>
              <div class="muted mt-1">ุงุฎุชุฑ ููุชุฌูุง ููุงุฆููุง (SELL) ูุญุณุงุจ ุงูุชูููุฉ ูุงูุชุณุนูุฑ ูุงููุณุงููุฉ.</div>
            </div>

            <div class="col-md-3">
              <label class="form-label">ุงููุชุฑุฉ</label>
              <select id="period" class="form-select">
                {% for pe in periods %}
                  <option value="{{ pe.id }}" {% if period and pe.id == period.id %}selected{% endif %}>{{ pe }}</option>
                {% endfor %}
              </select>
              <div class="muted mt-1">ุชูุณุชุฎุฏู ุงููุชุฑุฉ ูุงุฎุชูุงุฑ ุงูุชูููุฉ ุงูุตุญูุญุฉ ุนูุฏ ุงูุญุณุงุจ.</div>
            </div>

            <div class="col-md-2">
              <button id="applyBtn" class="btn btn-primary w-100">ุชุทุจูู</button>
              <div class="muted mt-1">ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุชุงุฆุฌ ููุฑูุง.</div>
            </div>

            <div class="col-md-3 text-start">
              <div class="alert alert-light mb-0">
                <div class="fw-bold">ููุงุญุธุฉ</div>
                <div class="muted">ุงููุชุงุฆุฌ ููุง ูููุญุงูุงุฉ ุฏุงุฎู iframeุ ููุง ูุชู ุญูุธ ุฃู ุดูุก ุฅูุง ุนูุฏ ุชูุนูู ุญูุธ ุณููุงุฑูู ูุงุญููุง.</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- โ ุงููุคุซุฑุงุช -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold">
          ๐ ุงูุณูุงุณุฉ / ุงููุคุซุฑุงุช
        </div>
        <div class="card-body">

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">
                ูุณุจุฉ ูุงูุด ุงูุฑุจุญ (ููุชุฌุงุช ุงูุจูุน) %
                <span class="text-primary" data-bs-toggle="tooltip" title="ุฒูุงุฏุฉ ุนูู ุงูุชูููุฉ ูููุตูู ูุณุนุฑ ููุชุฑุญ ููููุชุฌ ุงูููุงุฆู.">โน๏ธ</span>
              </label>
              <input id="markup_sell" type="number" class="form-control" value="60" step="0.01" placeholder="ูุซุงู: 60">
              <div class="muted mt-1">Markup ุนูู ุชูููุฉ ุงูููุชุฌ ุงูููุงุฆู (SELL).</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ูุณุจุฉ ุงูุฑุจุญ ุงููุณุชูุฏูุฉ %
                <span class="text-primary" data-bs-toggle="tooltip" title="ูุญุณูุจ ุณุนุฑูุง ูุญูู ูุงูุด ุฑุจุญ ูุญุฏุฏ: ุงูุณุนุฑ = ุงูุชูููุฉ / (1 - ุงููุงูุด).">โน๏ธ</span>
              </label>
              <input id="target_margin" type="number" class="form-control" value="0" step="0.01" placeholder="ูุซุงู: 30">
              <div class="muted mt-1">ุฅุฐุง ุฃุฏุฎูุช ูููุฉ &gt; 0 ุณููุนุงุฏ ุญุณุงุจ ุงูุณุนุฑ ููู ุงููุงูุด.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ุณุนุฑ ูุฏูู (ุชุฌุงูุฒ ุงูุญุณุงุจ)
                <span class="text-primary" data-bs-toggle="tooltip" title="ุนูุฏ ุฅุฏุฎุงู ุณุนุฑ ููุง ูุชู ุชุฌุงูู ูุนุงุฏูุงุช ุงูุชุณุนูุฑ ุงูุฃุฎุฑู.">โน๏ธ</span>
              </label>
              <input id="custom_price" type="number" class="form-control" value="0" step="0.01" placeholder="ุงุชุฑูู 0">
              <div class="muted mt-1">ุงุฎุชูุงุฑู: ููุฑุถ ุณุนุฑูุง ุซุงุจุชูุง ูููุญุงูุงุฉ.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ุงูุญุฏ ุงูุฃุฏูู ููุณุนุฑ
                <span class="text-primary" data-bs-toggle="tooltip" title="ูุง ูุณูุญ ุจุฃู ูููู ุงูุณุนุฑ ุงูููุชุฑุญ ุฃูู ูู ูุฐุง ุงูุฑูู.">โน๏ธ</span>
              </label>
              <input id="min_price" type="number" class="form-control" value="0" step="0.01" placeholder="0 = ุจุฏูู ุญุฏ">
              <div class="muted mt-1">ุญูุงูุฉ ูู ุชุณุนูุฑ ุฃูู ูู ุงูููุจูู.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ูุณุจุฉ ุชุญููู ุงููุตุฑููุงุช ุงูุชุดุบูููุฉ %
                <span class="text-primary" data-bs-toggle="tooltip" title="ุชุญููู ูุณุจุฉ ูู ุงูุณุนุฑ ูุชุบุทูุฉ ุงููุตุฑููุงุช ุงูุชุดุบูููุฉ (ุฅูุฌุงุฑ/ุฑูุงุชุจ/ููุฑุจุงุกโฆ).">โน๏ธ</span>
              </label>
              <input id="opex_percent" type="number" class="form-control" value="0" step="0.01" placeholder="ูุซุงู: 10">
              <div class="muted mt-1">OPEX% ูู ุงูุณุนุฑ ุงูููุชุฑุญ.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ูุตุฑููุงุช ุชุดุบูููุฉ ุซุงุจุชุฉ / ูููุญุฏุฉ
                <span class="text-primary" data-bs-toggle="tooltip" title="ูููุฉ ุซุงุจุชุฉ ุชูุฎุตู ูู ูุณุงููุฉ ุงูููุชุฌ ููู ูุญุฏุฉ ุจุบุถ ุงููุธุฑ ุนู ุงูุณุนุฑ.">โน๏ธ</span>
              </label>
              <input id="opex_unit" type="number" class="form-control" value="0" step="0.01" placeholder="ูุซุงู: 0.50">
              <div class="muted mt-1">OPEX ุซุงุจุช ููู ูุญุฏุฉ.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ูุณุจุฉ ุงูุฎุตู %
                <span class="text-primary" data-bs-toggle="tooltip" title="ุฎุตู ุนูู ุงูุณุนุฑ ุงูููุชุฑุญ ููุญุงูุงุฉ ุนุฑูุถ ูุฎุตููุงุช.">โน๏ธ</span>
              </label>
              <input id="discount_percent" type="number" class="form-control" value="0" step="0.01" placeholder="ูุซุงู: 5">
              <div class="muted mt-1">ูุทุจู ุจุนุฏ ุงูุชุณุนูุฑ ููุจู ุงูุถุฑูุจุฉ.</div>
            </div>

            <div class="col-6">
              <label class="form-label">
                ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ %
                <span class="text-primary" data-bs-toggle="tooltip" title="ููุฅุธูุงุฑ ููุท: ุงูุณุนุฑ ุดุงูู ุงูุถุฑูุจุฉ.">โน๏ธ</span>
              </label>
              <input id="vat_percent" type="number" class="form-control" value="0" step="0.01" placeholder="ูุซุงู: 15">
              <div class="muted mt-1">ูุง ุชุคุซุฑ ุนูู ุงูุฑุจุญ (ุนุฑุถ ููุท).</div>
            </div>

            <div class="col-12">
              <label class="form-label">
                ุฅุฌูุงูู ุงูุชูุงููู ุงูุซุงุจุชุฉ
                <span class="text-primary" data-bs-toggle="tooltip" title="ูุณุชุฎุฏู ูุญุณุงุจ ููุทุฉ ุงูุชุนุงุฏู: ุนุฏุฏ ุงููุญุฏุงุช ุงููุงุฒูุฉ ูุชุบุทูุฉ ุงูุชูุงููู ุงูุซุงุจุชุฉ.">โน๏ธ</span>
              </label>
              <input id="fixed_cost_total" type="number" class="form-control" value="0" step="0.01" placeholder="ุงุฎุชูุงุฑู">
              <div class="muted mt-1">ุณููุณุชุฎุฏู ูู Break-even Units ุฅุฐุง ูุงูุช ูุณุงููุฉ ุงููุญุฏุฉ ููุฌุจุฉ.</div>
            </div>
          </div>

          <hr class="my-3">
          <div class="alert alert-info mb-0">
            โ ูุนุชูุฏ ุงูุญุณุงุจ ุนูู ุชูููุฉ ุงููุตูุฉ (BOM) ุงููุญููุธุฉ <code>unit_cost_final</code>ุ ููู ุญุงู ุนุฏู ุชููุฑูุง ูุชู ุงุญุชุณุงุจ ุงูุชูููุฉ ุชููุงุฆููุง.
          </div>

        </div>
      </div>
    </div>

    <!-- โ ุงููุชุงุฆุฌ -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold">๐ ูุชุงุฆุฌ ุชุณุนูุฑ ุงูููุชุฌ</div>
        <div class="card-body">

          <div class="row g-2 mb-3">
            <div class="col-md-3">
              <div class="border rounded p-3">
                <div class="kpi"><small>ุงูุชูููุฉ (ูุญุฏุฉ)</small><span id="k_cost">โ</span></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <div class="kpi"><small>ุงูุณุนุฑ ุงูุญุงูู</small><span id="k_current">โ</span></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <div class="kpi"><small>ุงูุณุนุฑ ุงูููุชุฑุญ</small><span id="k_suggested">โ</span></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <div class="kpi"><small>ุงูููุชุฑุญ ุดุงูู ุงูุถุฑูุจุฉ</small><span id="k_suggested_vat">โ</span></div>
              </div>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-md-4">
              <div class="border rounded p-3">
                <div class="kpi"><small>ุชุญููู OPEX (ูู ุงูุณุนุฑ)</small><span id="k_opex_percent">โ</span></div>
                <div class="muted">ูููุฉ OPEX% ุงููุญุณูุจุฉ ุนูู ุงูุณุนุฑ ุงูููุชุฑุญ.</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3">
                <div class="kpi"><small>ูุณุงููุฉ ุงููุญุฏุฉ (Contribution)</small><span id="k_contribution">โ</span></div>
                <div class="muted">ุงูุณุนุฑ โ ุงูุชูููุฉ โ OPEX ุซุงุจุช โ OPEX%.</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3">
                <div class="kpi"><small>ููุทุฉ ุงูุชุนุงุฏู (ูุญุฏุงุช)</small><span id="k_breakeven">โ</span></div>
                <div class="muted">ุงูุชูุงููู ุงูุซุงุจุชุฉ รท ูุณุงููุฉ ุงููุญุฏุฉ.</div>
              </div>
            </div>
          </div>

          <hr class="my-3">
          <div class="muted" id="k_notes">โ</div>

        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  function val(id){ return document.getElementById(id).value; }
  function setText(id, v){ document.getElementById(id).innerText = v; }

  async function calc(){
    const product = val("product");
    if(!product){
      setText("k_notes","ุงุฎุชุฑ ููุชุฌูุง ุฃููุงู.");
      return;
    }

    const params = new URLSearchParams({
      product,
      period: val("period"),
      markup_sell: val("markup_sell"),
      target_margin: val("target_margin"),
      custom_price: val("custom_price"),
      opex_percent: val("opex_percent"),
      opex_unit: val("opex_unit"),
      discount_percent: val("discount_percent"),
      vat_percent: val("vat_percent"),
      min_price: val("min_price"),
      fixed_cost_total: val("fixed_cost_total"),
    });

    const res = await fetch(`/pricing/api/product-calc/?${params.toString()}`);
    const data = await res.json();

    if(!data.ok){
      setText("k_notes", data.error || "ุญุฏุซ ุฎุทุฃ");
      return;
    }

    setText("k_cost", data.cost.toFixed(2));
    setText("k_current", data.current_price.toFixed(2));
    setText("k_suggested", data.suggested_price.toFixed(2));
    setText("k_suggested_vat", data.suggested_price_vat.toFixed(2));
    setText("k_opex_percent", data.opex_amount_percent.toFixed(2));
    setText("k_contribution", data.contribution_per_unit.toFixed(2));
    setText("k_breakeven", data.breakeven_units.toFixed(2));
    setText("k_notes", data.notes || "");
  }


  // tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  function val(id){ return document.getElementById(id).value; }
  function setText(id, v){ document.getElementById(id).innerText = v; }

  let t = null;
  function debounceCalc(){
    clearTimeout(t);
    t = setTimeout(calc, 250); // 250ms ููุงูุฉ ูุณูุณุฉ
  }

  async function calc(){
    const product = val("product");
    if(!product){
      setText("k_notes","ุงุฎุชุฑ ููุชุฌูุง ุฃููุงู.");
      return;
    }

    const params = new URLSearchParams({
      product,
      period: val("period"),
      markup_sell: val("markup_sell"),
      target_margin: val("target_margin"),
      custom_price: val("custom_price"),
      opex_percent: val("opex_percent"),
      opex_unit: val("opex_unit"),
      discount_percent: val("discount_percent"),
      vat_percent: val("vat_percent"),
      min_price: val("min_price"),
      fixed_cost_total: val("fixed_cost_total"),
    });

    const res = await fetch(`/pricing/api/product-calc/?${params.toString()}`);
    const data = await res.json();

    if(!data.ok){
      setText("k_notes", data.error || "ุญุฏุซ ุฎุทุฃ");
      return;
    }

    setText("k_cost", data.cost.toFixed(2));
    setText("k_current", data.current_price.toFixed(2));
    setText("k_suggested", data.suggested_price.toFixed(2));
    setText("k_suggested_vat", data.suggested_price_vat.toFixed(2));
    setText("k_opex_percent", data.opex_amount_percent.toFixed(2));
    setText("k_contribution", data.contribution_per_unit.toFixed(2));
    setText("k_breakeven", data.breakeven_units.toFixed(2));
    setText("k_notes", data.notes || "");
  }

  // ุฒุฑ ุชุทุจูู ูุตุจุญ ุงุฎุชูุงุฑู (ุฎููู ููุฌูุฏ ูู Refresh)
  document.getElementById("applyBtn").addEventListener("click", calc);

  // โ ุชุญุฏูุซ ุชููุงุฆู ุฃุซูุงุก ุงููุชุงุจุฉ + ุงูุชุบููุฑ
  const ids = ["product","period","markup_sell","target_margin","custom_price","opex_percent","opex_unit","discount_percent","vat_percent","min_price","fixed_cost_total"];

  ids.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("change", calc);
    el.addEventListener("input", debounceCalc);  // โ ุฃูู ุณุทุฑ
  });

  // โ ุฃูู ุชุญููู (ูู ุงูููุชุฌ ูุฎุชุงุฑ)
  window.addEventListener("load", () => { if (val("product")) calc(); });


</script>

</body>
</html>
