{% load static %}
{% load numfmt %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير شجرة المكونات (BOM)</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <style>
        body {
            background-color: #f3f4f6;
            font-family: "Tahoma", sans-serif;
        }
        .report-wrapper {
            max-width: 1200px;
            margin: 25px auto 40px;
        }
        .card-main {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            padding: 24px 28px;
        }
        .report-title {
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .report-subtitle {
            text-align: center;
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 18px;
        }
        .filter-bar {
            background: #f9fafb;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 18px;
            border: 1px solid #e5e7eb;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .section-header span.badge-title {
            background: #2563eb;
            color: #fff;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
        }
        .tree-container {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 12px 14px;
            max-height: 420px;
            overflow-y: auto;
        }
        .tree-node {
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
        }
        .tree-node.level-0 { background-color: #e0f2fe; font-weight: 700; }
        .tree-node.level-1 { background-color: #dcfce7; }
        .tree-node.level-2 { background-color: #ffedd5; }
        .tree-node.level-3 { background-color: #f3e8ff; }
        .tree-node.level-4 { background-color: #fee2e2; }

        .tree-children {
            margin-right: 18px;
            border-right: 1px dashed #d1d5db;
            padding-right: 10px;
        }

        .table-summary, .table-details {
            font-size: 13px;
        }
        .table-summary th, .table-details th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .table-details tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .qty-cell {
            text-align: center;
            font-family: "Consolas", monospace;
        }
        .badge-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
        }
        .badge-final { background:#1d4ed8; color:#fff; }
        .badge-semi { background:#0f766e; color:#ecfdf5; }
        .badge-raw { background:#6b7280; color:#f9fafb; }

        .small-note {
            font-size: 11px;
            color: #9ca3af;
        }
        hr.soft {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 14px 0;
        }
    </style>

    <!-- jQuery (مطلوب لـ Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* ضبط شكل Select2 ليتناسق مع Bootstrap */
    .select2-container--default .select2-selection--single {
        height: 31px;
        padding: 3px 6px;
        font-size: 0.875rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 24px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 28px;
    }
</style>

</head>
<body>

<div class="report-wrapper">
    <div class="card-main">
        <div class="report-title">تقرير شجرة المكوّنات (Bill of Materials)</div>
        <div class="report-subtitle">
            تحليل المنتج النهائي إلى المنتجات النصف مصنّعة والمواد الخام مع ملخّص كلي للاستهلاك.
        </div>

        <!-- شريط الفلاتر -->
        <form method="get" class="filter-bar row g-2 align-items-end">
            <div class="col-md-7">
                <label class="form-label mb-1">اختر المنتج النهائي</label>
                <select name="product" class="form-select form-select-sm js-product-select" required>
                    <option value="">-- اختر منتجاً نهائياً --</option>
                    {% for p in products %}
                        <option value="{{ p.id }}"
                            {% if selected_product and p.id == selected_product.id %}selected{% endif %}>
                            {{ p.code }} - {{ p.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label mb-1">الكمية المطلوبة</label>
                <input type="number" step="0.0001" name="qty"
                       value="{{ quantity|default:1 }}" class="form-control form-control-sm">
            </div>

            <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    عرض الشجرة
                </button>
            </div>
        </form>

        {% if selected_product %}
            <hr class="soft">

            <!-- معلومات المنتج المختار -->
            <div class="mb-2">
                <strong>المنتج:</strong>
                {{ selected_product.code }} - {{ selected_product.name }}
                &nbsp; | &nbsp;
                <strong>الكمية:</strong> {{ quantity }}
            </div>

            <div class="row mt-3">
                <!-- الشجرة -->
                <div class="col-md-7">
                    <div class="section-header">
                        <span class="badge-title">عرض هرمي</span>
                        <span>شجرة المكونات التفصيلية</span>
                    </div>
                    <div class="tree-container">
                        {% include "partials/_bom_tree_node.html" with node=tree level=0 %}
                    </div>
                    <div class="small-note mt-1">
                        لون مختلف لكل مستوى في الشجرة لتمييز المنتج النهائي، النصف مصنع، والمواد الخام.
                    </div>
                </div>

                <!-- ملخص المواد الخام -->
                <div class="col-md-5">
                    <div class="section-header">
                        <span class="badge-title">ملخّص</span>
                        <span>المواد الخام الفعلية المستهلكة</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-summary table-sm table-bordered align-middle mb-2">
                            <thead>
                                <tr>
                                    <th style="width: 65%;">المادة الخام</th>
                                    <th class="text-center" style="width: 35%;">إجمالي الكمية</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if flat_summary %}
                                    {% for row in flat_summary %}
                                        {% with m=row.material %}
                                            <tr>
                                                <td>{{ m.sku|default:m.id }} - {{ m.name }}</td>
                                                <td class="qty-cell">{{ row.quantity|num:4 }}</td>
                                            </tr>
                                        {% endwith %}
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2" class="text-center text-muted">
                                            لا توجد مواد خام، ربما المنتج غير مرتبط بوصفة (BOM).
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="small-note">
                        الجدول يعرض إجمالي استهلاك كل مادة خام بعد فكّ جميع مستويات المنتج (بما في ذلك المنتجات النصف مصنّعة).
                    </div>
                </div>
            </div>

            <!-- جدول تفصيلي لكل المكونات -->
            <hr class="soft mt-4">

            <div class="section-header">
                <span class="badge-title">تفاصيل</span>
                <span>جدول تفصيلي لكل المكوّنات حسب المستوى</span>
            </div>

            <div class="table-responsive">
                <table class="table table-details table-sm table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 8%;" class="text-center">المستوى</th>
                            <th style="width: 15%;">الكود</th>
                            <th style="width: 32%;">الاسم</th>
                            <th style="width: 18%;">النوع</th>
                            <th style="width: 15%;" class="text-center">الكمية</th>
                            <th style="width: 12%;">ينتمي إلى</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if node_rows %}
                            {% include "partials/_bom_tree_table_rows.html" with rows=node_rows %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    لا توجد بيانات للعرض.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="small-note">
                * المستوى (0) هو المنتج النهائي، المستويات التالية تمثل المكونات المتداخلة نزولاً حتى المواد الخام.
            </div>

        {% else %}
            <div class="alert alert-info mt-3 mb-0 text-center">
                برجاء اختيار منتج نهائي ثم الضغط على زر <strong>عرض الشجرة</strong>.
            </div>
        {% endif %}
    </div>
</div>
<script>
    $(document).ready(function() {
        $('.js-product-select').select2({
            width: '100%',
            placeholder: "ابحث باسم المنتج أو الكود",
            allowClear: true,
            dir: "rtl"
        });
    });
</script>

</body>
</html>
