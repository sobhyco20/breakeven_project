{% load static %}
{% load numfmt %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير شجرة المكونات (BOM)</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: "Tahoma", sans-serif;
        }
        .report-container {
            max-width: 1100px;
            margin: 30px auto;
            background: #fff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.08);
        }
        .tree-container {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px 20px;
            max-height: 450px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        .tree-node {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 6px;
        }
        .tree-node.level-0 { background-color: #e3f2fd; font-weight: bold; }
        .tree-node.level-1 { background-color: #e8f5e9; }
        .tree-node.level-2 { background-color: #fff3e0; }
        .tree-node.level-3 { background-color: #f3e5f5; }
        .tree-node.level-4 { background-color: #ffebee; }

        .tree-children {
            margin-right: 25px;
            border-right: 1px dashed #ccc;
            padding-right: 10px;
        }

        .section-title {
            border-right: 5px solid #007bff;
            padding-right: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="report-container">
    <h3 class="mb-3 text-center">تقرير شجرة المكونات (Bill of Materials)</h3>

    <!-- نموذج اختيار المنتج -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-6">
            <label class="form-label">اختر المنتج النهائي</label>
            <select name="product" class="form-select" required>
                <option value="">-- اختر منتجاً --</option>
                {% for p in products %}
                    <option value="{{ p.id }}"
                        {% if selected_product and p.id == selected_product.id %}selected{% endif %}>
                        {{ p.code }} - {{ p.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">الكمية المطلوبة</label>
            <input type="number" step="0.0001" name="qty" value="{{ quantity|default:1 }}" class="form-control">
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">عرض الشجرة</button>
        </div>
    </form>

    {% if selected_product %}
        <hr>

        <div class="mb-3">
            <h5 class="section-title">
                المنتج: {{ selected_product.code }} - {{ selected_product.name }}
                &nbsp; | &nbsp;
                الكمية: {{ quantity }}
            </h5>
        </div>

        <div class="row">
            <!-- شجرة المكونات -->
            <div class="col-md-7">
                <h6 class="mb-2">شجرة المكونات التفصيلية</h6>
                <div class="tree-container">
                    {% include "inventory/partials/_bom_tree_node.html" with node=tree level=0 %}
                </div>
            </div>

            <!-- ملخص المواد الخام -->
            <div class="col-md-5">
                <h6 class="mb-2">ملخص المواد الخام الفعلية المستهلكة</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>المادة الخام</th>
                                <th class="text-center">إجمالي الكمية</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if flat_summary %}
                                {% for row in flat_summary %}
                                    <tr>
                                        <td>{{ row.product.code }} - {{ row.product.name }}</td>
                                        <td class="text-center">{{ row.quantity|num:4 }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">
                                        لا توجد مواد خام، ربما المنتج معرف كمادة خام بدون مكونات.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% else %}
        <div class="alert alert-info mt-3 text-center">
            برجاء اختيار منتج ثم الضغط على زر <strong>عرض الشجرة</strong>.
        </div>
    {% endif %}
</div>

</body>
</html>
