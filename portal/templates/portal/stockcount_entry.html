{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{{ page_title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#fff;
      --muted:#6c757d;
      --border:#e6e8ee;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:16px;
      --opening:#f59e0b;
      --closing:#16a34a;
      --danger:#ef4444;
      --info:#0ea5e9;
    }
    body{background:var(--bg)}
    .card-soft{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .65rem;border-radius:999px;background:#f1f3f5;font-size:.85rem;border:1px solid var(--border)}
    .chip.success{background:#eaf7ee}
    .chip.warn{background:#fff7e6}
    .chip.danger{background:#fff1f2}
    .title{font-weight:900}
    .sub{color:var(--muted);font-size:.9rem}
    .topbar{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .type-strip{height:6px;border-radius:999px;width:100%;background:linear-gradient(90deg,var(--opening),#fde68a)}
    .type-strip.closing{background:linear-gradient(90deg,var(--closing),#bbf7d0)}
    .table thead th{background:#f8fafc}
    .muted{color:var(--muted)}
    .unit-cell{min-width:140px}
    .sticky-foot{position:sticky;bottom:12px;z-index:5}
    .opening-cost{
      background:#fff7e6;
      border-color:#f59e0b !important;
    }
    .row-muted{background:#fbfdff}
    .btn-compact{white-space:nowrap}
    .badge-note{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.25rem .55rem;border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:.82rem;
      color:#334155;
    }
    .toolbar-right{display:flex;gap:.5rem;flex-wrap:wrap;justify-content-lg-end}
  </style>
</head>

<body>
<div class="container-fluid py-3">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h4 class="m-0 title">{{ page_title }}</h4>
      <div class="sub">
        Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø§Ù‡Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ (RAW + SEMI) â€” Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙÙ‚Ø·.
        <span class="badge-note ms-1">ÙˆÙÙŠ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©: Ø£Ø¯Ø®Ù„ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§</span>
      </div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <span class="chip" id="chipPeriod">ğŸ—“ Ø§Ù„ÙØªØ±Ø©: â€¦</span>
      <span class="chip" id="chipType">ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹: â€¦</span>
      <span class="chip" id="chipLock">â€¦</span>
    </div>
  </div>

  <!-- Settings TOP only -->
  <div class="topbar mb-3">
    <div id="typeStrip" class="type-strip mb-2"></div>

    <div class="row g-2 align-items-end">
      <div class="col-lg-4">
        <label class="form-label fw-bold">Ø§Ù„ÙØªØ±Ø©</label>
        <select class="form-select" id="selPeriod">
          {% for p in periods %}
            <option value="{{ p.id }}" {% if period and p.id == period.id %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-lg-4">
        <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¯</label>
        <select class="form-select" id="selType">
          <option value="opening" {% if count_type == "opening" %}selected{% endif %}>Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„ÙØªØ±Ø©</option>
          <option value="closing" {% if count_type == "closing" %}selected{% endif %}>Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„ÙØªØ±Ø©</option>
        </select>
        <div class="small muted mt-1" id="msgType"></div>
      </div>

      <div class="col-lg-4">
        <div class="toolbar-right">
          <button class="btn btn-outline-primary btn-compact" id="btnRecalc">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨</button>
          <button class="btn btn-outline-danger btn-compact" id="btnClearAll">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
          <button class="btn btn-success btn-compact" id="btnSubmit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main table -->
  <div class="card-soft">
    <div class="p-3">
      {% if not period %}
        <div class="alert alert-warning m-0">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØªØ±Ø§Øª.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-bordered bg-white align-middle mb-0">
            <thead>
              <tr>
                <th style="width:44%">Ø§Ù„ØµÙ†Ù</th>
                <th class="unit-cell" style="width:18%">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th style="width:14%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th style="width:12%">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th style="width:12%">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3 flex-wrap">
          <span class="chip">ğŸ”¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: <b id="totalQty">0.00</b></span>
          <span class="chip">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <b id="totalCost">0.00</b></span>
        </div>

        <div class="sticky-foot mt-3 d-flex justify-content-between flex-wrap gap-2">
          <div class="small muted">* Ù„Ùˆ Ø§Ù„ÙØªØ±Ø© Ù…Ù‚ÙÙˆÙ„Ø© Ø£Ùˆ Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©: Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.</div>
          <div class="small muted">Double-click Ø¹Ù„Ù‰ Ø®Ø§Ù†Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© Ø³Ø±ÙŠØ¹Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).</div>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
  const API_STATE   = "/portal/api/inventory/stockcount/state/";
  const API_UNITS   = "/portal/api/inventory/units/list/";
  const API_UPD     = "/portal/api/inventory/stockcount/update-line/";
  const API_RECALC  = "/portal/api/inventory/stockcount/recalc/";
  const API_CLEAR   = "/portal/api/inventory/stockcount/clear-all/";
  const API_SUBMIT  = "/portal/api/inventory/stockcount/submit/";

  let COUNT_ID = null;
  let LOCKED   = false;
  let COUNT_TYPE = "opening";

  const selPeriod = document.getElementById("selPeriod");
  const selType   = document.getElementById("selType");

  const chipPeriod = document.getElementById("chipPeriod");
  const chipType   = document.getElementById("chipType");
  const chipLock   = document.getElementById("chipLock");
  const typeStrip  = document.getElementById("typeStrip");
  const msgType    = document.getElementById("msgType");

  const tbody     = document.getElementById("tbody");
  const totalQty  = document.getElementById("totalQty");
  const totalCost = document.getElementById("totalCost");

  const btnRecalc   = document.getElementById("btnRecalc");
  const btnClearAll = document.getElementById("btnClearAll");
  const btnSubmit   = document.getElementById("btnSubmit");

  function csrfToken(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  async function jget(url, params={}){
    const u = new URL(url, window.location.origin);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
    const r = await fetch(u.toString(), {credentials:"same-origin"});
    return await r.json();
  }

  async function jpost(url, body={}){
    const form = new FormData();
    Object.entries(body).forEach(([k,v]) => form.append(k, v));
    const r = await fetch(url, {
      method:"POST",
      body: form,
      credentials:"same-origin",
      headers: {"X-CSRFToken": csrfToken()}
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "Request failed");
    return data;
  }

  function warn(msg){ alert(msg); }

  // ====== format 2 decimals ======
  const NF2 = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function fmt2(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    if(s === "") return "";
    const n = Number(s.replace(/,/g,""));
    if(Number.isNaN(n)) return s;
    return NF2.format(n);
  }

  function parseNum(v){
    const s = String(v ?? "").trim().replace(/,/g,"");
    if(s === "") return null;
    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function debounce(fn, ms=300){
    let t=null;
    return (...args)=>{
      clearTimeout(t);
      t=setTimeout(()=>fn(...args), ms);
    };
  }

  function setTypeUI(t){
    const isClosing = (t === "closing");
    chipType.textContent = "ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹: " + (isClosing ? "Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„ÙØªØ±Ø©" : "Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„ÙØªØ±Ø©");
    typeStrip.classList.toggle("closing", isClosing);
  }

  function setLockUI(){
    if(LOCKED){
      chipLock.textContent = "ğŸ”’ Ù…Ù‚ÙÙˆÙ„";
      chipLock.className = "chip danger";
    }else{
      chipLock.textContent = "âœ… Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„";
      chipLock.className = "chip success";
    }
    btnRecalc.disabled   = LOCKED;
    btnClearAll.disabled = LOCKED;
    btnSubmit.disabled   = LOCKED;
  }

  function rowHtml(row){
    const isOpening = (COUNT_TYPE === "opening");

    const costCell = isOpening
      ? `<input class="form-control form-control-sm unit_cost_value text-end opening-cost"
                value="${row.unit_cost ?? ""}"
                placeholder="0.00"
                ${LOCKED ? "disabled" : ""}>`
      : `<span class="unit_cost">${fmt2(row.unit_cost ?? "")}</span>`;

    const qtyVal = (row.qty === null || row.qty === undefined || row.qty === "") ? "0" : row.qty;

    return `
      <tr data-id="${row.id}" class="${isOpening ? "row-muted" : ""}">
        <td>
          <div class="fw-semibold">${row.item_label||""}</div>
          <div class="small muted">${row.item_type==="raw"?"RAW":"SEMI"}</div>
        </td>

        <td>
          <input class="form-control form-control-sm unit" value="${row.unit_label||""}" placeholder="ÙˆØ­Ø¯Ø©" ${LOCKED?"disabled":""}>
          <input type="hidden" class="unit_id" value="${row.unit_id||""}">
        </td>

        <td>
          <input class="form-control form-control-sm qty text-end" value="${fmt2(qtyVal)}" ${LOCKED?"disabled":""}>
        </td>

        <td class="text-end">${costCell}</td>

        <td class="text-end"><span class="total_cost">${fmt2(row.total_cost ?? "")}</span></td>
      </tr>
    `;
  }

  function bindRowEvents(){
    tbody.querySelectorAll("tr").forEach(tr=>{
      const qtyInput = tr.querySelector(".qty");
      const saveLater = debounce(()=> saveRow(tr), 450);

      qtyInput.addEventListener("input", saveLater);
      qtyInput.addEventListener("change", ()=> saveRow(tr));

      tr.querySelector(".unit").addEventListener("dblclick", async ()=>{
        if(LOCKED) return;
        const k = prompt("Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:");
        if(k === null) return;
        const res = await jget(API_UNITS, {q:k});
        const pick = (res.units||[])[0];
        if(!pick){ warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø©"); return; }
        tr.querySelector(".unit").value = pick.label;
        tr.querySelector(".unit_id").value = pick.id;
        await saveRow(tr);
      });

      const costInp = tr.querySelector(".unit_cost_value");
      if(costInp){
        costInp.addEventListener("input", debounce(()=> saveRow(tr), 600));
        costInp.addEventListener("change", ()=> saveRow(tr));
      }

      qtyInput.addEventListener("blur", ()=>{
        const n = parseNum(qtyInput.value);
        if(n !== null) qtyInput.value = fmt2(n);
      });

      if(costInp){
        costInp.addEventListener("blur", ()=>{
          const n = parseNum(costInp.value);
          if(n !== null) costInp.value = fmt2(n);
        });
      }
    });
  }

  async function saveRow(tr){
    if(LOCKED){ return; }

    const qtyRaw  = (tr.querySelector(".qty").value || "").trim();
    const unit_id = (tr.querySelector(".unit_id").value || "").trim();

    if(!unit_id){
      warn("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© (Double-click Ø¹Ù„Ù‰ Ø®Ø§Ù†Ø© Ø§Ù„ÙˆØ­Ø¯Ø©).");
      return;
    }

    const qtyNum = parseNum(qtyRaw);
    if(qtyNum === null){ return; }
    if(qtyNum < 0){
      warn("âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø©.");
      return;
    }

    const payload = {
      line_id: tr.dataset.id,
      qty: String(qtyNum),
      unit_id,
    };

    if(COUNT_TYPE === "opening"){
      const c = tr.querySelector(".unit_cost_value");
      const raw = c ? String(c.value ?? "").trim() : "";
      const cNum = parseNum(raw);

      if(raw === ""){
        payload.unit_cost_value = "";
      }else if(cNum === null || cNum < 0){
        warn("âš ï¸ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        return;
      }else{
        payload.unit_cost_value = String(cNum);
      }
    }

    try{
      await jpost(API_UPD, payload);
      await loadState();
    }catch(e){
      warn(e.message);
      await loadState();
    }
  }

  async function loadState(){
    const period_id = selPeriod.value;
    const req_type  = selType.value;

    const data = await jget(API_STATE, {period_id, type: req_type});
    if(!data.ok){ warn(data.error || "Ø®Ø·Ø£"); return; }

    COUNT_ID   = data.count_id;
    LOCKED     = !!data.locked;
    COUNT_TYPE = data.effective_type || data.count_type || req_type;

    chipPeriod.textContent = "ğŸ—“ Ø§Ù„ÙØªØ±Ø©: " + (data.period?.label || "");
    setTypeUI(COUNT_TYPE);
    setLockUI();

    msgType.textContent = data.message || "";

    if(COUNT_TYPE !== req_type){
      selType.value = COUNT_TYPE;
    }

    tbody.innerHTML = (data.lines||[]).map(rowHtml).join("");

    totalQty.textContent  = fmt2(data.totals?.total_qty  || "0");
    totalCost.textContent = fmt2(data.totals?.total_cost || "0");

    bindRowEvents();
  }

  async function submitCount(){
    if(LOCKED) return;

    if(COUNT_TYPE === "opening"){
      if(!confirm("âš ï¸ Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø³ØªØ­ÙØ¸ (ÙˆØªÙ‚ÙÙ„) Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„ÙØªØ±Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ 100%ØŸ")) return;
      if(!confirm("ğŸ§¨ ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ù„Ù† ØªØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„ÙØªØ±Ø© Ø¥Ù„Ø§ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ÙØªØ±Ø§Øª ÙˆØ¨ØµÙ„Ø§Ø­ÙŠØ© ÙØªØ­ Ø®Ø§ØµØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
      if(!confirm("âœ… Ø¢Ø®Ø± ØªØ£ÙƒÙŠØ¯: Ù‡Ù„ Ø±Ø§Ø¬Ø¹Øª Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
    }else{
      if(!confirm("âš ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸/Ø¥Ù‚ÙØ§Ù„ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„ÙØªØ±Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    }

    try{
      await jpost(API_SUBMIT, {count_id: COUNT_ID});
      await loadState();
      warn("âœ… ØªÙ… Ø­ÙØ¸/Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
    }catch(e){
      warn(e.message);
      await loadState();
    }
  }

  selPeriod.addEventListener("change", loadState);
  selType.addEventListener("change", loadState);

  btnRecalc.addEventListener("click", async ()=>{
    if(LOCKED) return;
    if(!confirm("âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ØŸ")) return;
    try{
      await jpost(API_RECALC, {count_id: COUNT_ID});
      await loadState();
    }catch(e){ warn(e.message); }
  });

  btnClearAll.addEventListener("click", async ()=>{
    if(LOCKED) return;
    if(!confirm("ğŸ§¨ Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ø±Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    try{
      await jpost(API_CLEAR, {count_id: COUNT_ID});
      await loadState();
    }catch(e){ warn(e.message); }
  });

  btnSubmit.addEventListener("click", submitCount);

  (async function init(){
    await loadState();
  })();
</script>

</body>
</html>
