{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø§Ù„ÙØªØ±Ø§Øª + Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬Ø±Ø¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#fff;
      --muted:#6c757d;
      --border:#e6e8ee;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:16px;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#2563eb;
    }
    body{background:var(--bg)}
    .card-soft{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .title{font-weight:900}
    .sub{color:var(--muted);font-size:.9rem}
    .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:.85rem}
    .chip.ok{background:#eaf7ee}
    .chip.bad{background:#fff1f2}
    .chip.warn{background:#fff7e6}
    .table thead th{background:#f8fafc}
    .muted{color:var(--muted)}
    .btn-xxs{padding:.2rem .45rem;font-size:.78rem;border-radius:10px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>

<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h4 class="m-0 title">ğŸ—“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØªØ±Ø§Øª + ğŸ” Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬Ø±Ø¯</h4>
      <div class="sub">ÙØªØ­/Ù‚ÙÙ„ Ø§Ù„Ø¬Ø±Ø¯ ÙŠØªÙ… Ù…Ù† Ù‡Ù†Ø§ ÙÙ‚Ø· â€” Ù…Ø¹ Ù‚ÙŠÙˆØ¯ Ø­Ø³Ø¨ ÙˆØ¬ÙˆØ¯ Ø­Ø±ÙƒØ©.</div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <span class="chip" id="chipCount">â€¦</span>
      <span class="chip warn">âš ï¸ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø© ÙŠÙÙ…Ù†Ø¹ ÙØªØ­Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©</span>
    </div>
  </div>

  <div class="card-soft">
    <div class="p-3">
      <div class="table-responsive">
        <table class="table table-bordered bg-white align-middle mb-0">
          <thead>
            <tr>
              <th style="width:12%">Ø§Ù„ÙØªØ±Ø©</th>
              <th style="width:12%">Ø­Ø§Ù„Ø© Ø§Ù„ÙØªØ±Ø©</th>
              <th style="width:12%">Ø­Ø±ÙƒØ©</th>
              <th style="width:32%">Ø§Ù„Ø¬Ø±Ø¯</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="mt-3 small muted">
        - ÙØªØ­ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©: Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¥Ø°Ø§ Ø§Ù„ÙØªØ±Ø© Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©.<br>
        - ÙØªØ­ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø©: Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¥Ø°Ø§ Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©.<br>
        - ØªÙ‚Ø¯Ø± ØªØ±Ø¨Ø· â€œØ§Ù„Ø­Ø±ÙƒØ©â€ Ø¨ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙ„Ø§ØªÙƒ (Ù…Ø¨ÙŠØ¹Ø§Øª/Ù…Ø´ØªØ±ÙŠØ§Øª/Ù…Ø®Ø²ÙˆÙ†/Ù…ØµØ±ÙˆÙØ§Øª) Ø¯Ø§Ø®Ù„ `_has_period_activity`.
      </div>
    </div>
  </div>
</div>

<script>
  const API_LIST  = "/portal/api/periods/list/";
  const API_STOCK = "/portal/api/periods/stock-toggle/";

  const tbody = document.getElementById("tbody");
  const chipCount = document.getElementById("chipCount");

  function csrfToken(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  async function jget(url, params={}){
    const u = new URL(url, window.location.origin);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
    const r = await fetch(u.toString(), {credentials:"same-origin"});
    return await r.json();
  }

  async function jpost(url, body={}){
    const form = new FormData();
    Object.entries(body).forEach(([k,v])=>form.append(k,v));
    const r = await fetch(url, {
      method:"POST",
      body: form,
      credentials:"same-origin",
      headers: {"X-CSRFToken": csrfToken()}
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "Request failed");
    return data;
  }

  function badgePeriodClosed(is_closed){
    return is_closed
      ? `<span class="chip bad">ğŸ”’ Ù…Ù‚ÙÙ„Ø©</span>`
      : `<span class="chip ok">âœ… Ù…ÙØªÙˆØ­Ø©</span>`;
  }

  function badgeActivity(has){
    return has
      ? `<span class="chip warn">âš ï¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©</span>`
      : `<span class="chip ok">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`;
  }

  function stockControls(row){
    const openingOn  = !!row.allow_opening_stock;
    const closingOn  = !!row.allow_closing_stock;
    const blocked    = !!row.closing_blocked;

    const btnOpenOpening = openingOn
      ? `<button class="btn btn-xxs btn-outline-danger js-stock" data-id="${row.id}" data-kind="opening" data-action="close">Ù‚ÙÙ„ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©</button>`
      : `<button class="btn btn-xxs btn-outline-primary js-stock" data-id="${row.id}" data-kind="opening" data-action="open">ÙØªØ­ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©</button>`;

    const btnOpenClosing = closingOn
      ? `<button class="btn btn-xxs btn-outline-danger js-stock" data-id="${row.id}" data-kind="closing" data-action="close">Ù‚ÙÙ„ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø©</button>`
      : `<button class="btn btn-xxs btn-outline-success js-stock" data-id="${row.id}" data-kind="closing" data-action="open" ${blocked ? "disabled" : ""}>ÙØªØ­ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø©</button>`;

    const hint = blocked
      ? `<span class="chip bad">ğŸš« Ù…Ù…Ù†ÙˆØ¹ ÙØªØ­ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø© (Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø±ÙƒØ©)</span>`
      : `<span class="chip ok">âœ… Ù…Ø³Ù…ÙˆØ­ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø©</span>`;

    return `
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="chip ${openingOn?'ok':'warn'}">Opening: ${openingOn ? "Ù…ÙØªÙˆØ­" : "Ù…Ù‚ÙÙˆÙ„"}</span>
        <span class="chip ${closingOn?'ok':'warn'}">Closing: ${closingOn ? "Ù…ÙØªÙˆØ­" : "Ù…Ù‚ÙÙˆÙ„"}</span>
        ${hint}
        <div class="d-flex gap-2 flex-wrap">
          ${btnOpenOpening}
          ${btnOpenClosing}
          <a class="btn btn-xxs btn-outline-dark" target="_parent"
             href="/portal/stockcount/?embed=1&period=${row.id}&type=opening">ÙØªØ­ Ø´Ø§Ø´Ø© Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©</a>
          <a class="btn btn-xxs btn-outline-dark" target="_parent"
             href="/portal/stockcount/?embed=1&period=${row.id}&type=closing">ÙØªØ­ Ø´Ø§Ø´Ø© Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø©</a>
        </div>
      </div>
    `;
  }

  function notesCell(row){
    const o = row.opening_note ? `ğŸŸ  ${row.opening_note}` : "";
    const c = row.closing_note ? `ğŸŸ¢ ${row.closing_note}` : "";
    if(!o && !c) return `<span class="muted">â€”</span>`;
    return `<div class="small">${o ? `<div>${o}</div>`:""}${c ? `<div>${c}</div>`:""}</div>`;
  }

  function rowHtml(row){
    return `
      <tr>
        <td class="text-nowrap"><span class="kbd">${row.label}</span></td>
        <td>${badgePeriodClosed(row.is_closed)}</td>
        <td>${badgeActivity(row.has_activity)}</td>
        <td>${stockControls(row)}</td>
        <td>${notesCell(row)}</td>
      </tr>
    `;
  }

  async function load(){
    const data = await jget(API_LIST);
    if(!data.ok){ alert(data.error || "Ø®Ø·Ø£"); return; }
    const rows = data.rows || [];
    chipCount.textContent = `ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„ÙØªØ±Ø§Øª: ${rows.length}`;
    tbody.innerHTML = rows.map(rowHtml).join("");
  }

  async function handleStockToggle(btn){
    const id = btn.getAttribute("data-id");
    const kind = btn.getAttribute("data-kind");     // opening|closing
    const action = btn.getAttribute("data-action"); // open|close

    if(kind === "opening" && action === "open"){
      if(!confirm("âš ï¸ ÙØªØ­ Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø© Ø¥Ø¬Ø±Ø§Ø¡ Ø­Ø³Ø§Ø³. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
      if(!confirm("ğŸ§¨ ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ù„Ø§ ØªÙØªØ­ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø© Ø¥Ù„Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ Ø­Ø±ÙƒØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
      if(!confirm("âœ… Ø¢Ø®Ø± ØªØ£ÙƒÙŠØ¯: Ø³ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø´Ø§Ø´Ø© Ø¬Ø±Ø¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¢Ù†. Ù…ÙˆØ§ÙÙ‚ØŸ")) return;
    }

    if(kind === "closing" && action === "open"){
      if(!confirm("âš ï¸ ÙØªØ­ Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø­Ø±ÙƒØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
    }

    if(action === "close"){
      if(!confirm("âš ï¸ Ø³ÙŠØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¬Ø±Ø¯. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
    }

    try{
      await jpost(API_STOCK, {id, kind, action});
      await load();
      alert("âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
    }catch(e){
      alert(e.message);
      await load();
    }
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest(".js-stock");
    if(btn) return handleStockToggle(btn);
  });

  load();
</script>

</body>
</html>
